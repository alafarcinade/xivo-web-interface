#!/bin/sh

set -e

XIVO_VERSION_INSTALLED=$(echo $2 | grep -oE '([0-9]{2}\.[0-9]+|1\.2\.[0-9]{1,2})' | head -n1)

float_test() {
	echo | awk 'END { exit ( !( '"$1"')); }'
}

case "$1" in
	install|upgrade)
		postrm_webi_config="/var/lib/dpkg/info/pf-xivo-web-interface-config.postrm"
		if [ -f $postrm_webi_config ]; then
			if [ -d /etc/pf-xivo/web-interface ]; then
				rsync -av /etc/pf-xivo/web-interface /tmp/ > /dev/null
			fi
			rm -rf $postrm_webi_config > /dev/null
		fi

		old_webi_config_dir='/etc/pf-xivo/web-interface'
		if [ -n "$XIVO_VERSION_INSTALLED" ] && float_test "$XIVO_VERSION_INSTALLED < 13.04" ; then
			for file in xivo ipbx cti; do
				mv ${old_webi_config_dir}/${file}.ini ${old_webi_config_dir}/${file}.ini.xivo-upgrade-old
			done
		fi
	;;

	abort-upgrade)
	;;

	*)
		echo "preinst called with unknown argument \`$1'" >&2
		exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
